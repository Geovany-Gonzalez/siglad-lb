# =========================
#   NGINX - SIGLAD LB
#   Sticky cookie + 50/50
#   JSON logs (latencia, upstream, etc.)
# =========================

worker_processes auto;
pid        off;
error_log  /dev/stderr info;

events { worker_connections 1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;

  # DNS para upstreams (Render)
  resolver 1.1.1.1 1.0.0.1 valid=300s ipv6=off;

  # --------- LOGS EN JSON (mejor para dashboards) ----------
  # request_id de respaldo si $request_id no existe
  map $request_id $rid { default $request_id; "" "$msec-$remote_addr"; }

  log_format main escape=json
    '{'
      '"ts":"$time_iso8601",'
      '"remote_addr":"$remote_addr",'
      '"method":"$request_method",'
      '"uri":"$request_uri",'
      '"protocol":"$server_protocol",'
      '"status":$status,'
      '"bytes":$body_bytes_sent,'
      '"referer":"$http_referer",'
      '"user_agent":"$http_user_agent",'
      '"host":"$host",'
      '"uback":"$backend_host",'
      '"uaddr":"$upstream_addr",'
      '"ustatus":"$upstream_status",'
      '"rt":$request_time,'
      '"urt":"$upstream_response_time",'
      '"cache":"$upstream_cache_status",'
      '"rid":"$rid"'
    '}';

  access_log /dev/stdout main;

  # --------- BALANCEO 50/50 + STICKY POR COOKIE ----------
  # Elección inicial (sin cookie): 50/50
  # Asegúrate de estos FQDN:
  #   - siglad-proyectoii.onrender.com
  #   - siglad-proyecto.onrender.com
  split_clients "${remote_addr}${http_user_agent}" $lb_choice {
    50% "siglad-proyectoii.onrender.com";
    *   "siglad-proyecto.onrender.com";
  }

  # Si ya hay cookie, respétala; si no, usar elección y setear cookie
  map $cookie_lb_upstream $backend_host {
    default $cookie_lb_upstream;
    ""      $lb_choice;
  }

  # Host/SNI correcto hacia Render
  map $backend_host $host_hdr { default $backend_host; }

  # WebSockets
  map $http_upgrade $connection_upgrade { default upgrade; "" close; }

  # Compresión para texto
  gzip on;
  gzip_types text/plain text/css application/json application/javascript application/xml text/javascript;
  gzip_min_length 1024;

  server {
    listen 8080;

    # --------- ENDPOINTS DE DIAGNÓSTICO ----------
    location = /_lb/which  { add_header Content-Type text/plain; return 200 "$backend_host\n"; }
    location = /_lb/health { add_header Content-Type text/plain; return 200 "ok\n"; }
    location = /_lb/nginx_status {
      stub_status;
      access_log off;
    }

    # --------- PROXY PRINCIPAL ----------
    location / {
      # Fijar cookie sticky si falta (1 día)
      if ($cookie_lb_upstream = "") {
        add_header Set-Cookie "lb_upstream=$backend_host; Path=/; HttpOnly; SameSite=Lax; Max-Age=86400" always;
      }

      proxy_pass https://$backend_host;

      # Host correcto para TLS/SNI en Render
      proxy_set_header Host              $host_hdr;
      # Conserva el host público del LB para trazas
      proxy_set_header X-Forwarded-Host  $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

      proxy_ssl_server_name on;
      proxy_ssl_name        $backend_host;

      # WebSockets
      proxy_set_header Upgrade    $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      # Timeouts/robustez
      proxy_connect_timeout 5s;
      proxy_read_timeout    30s;
      proxy_send_timeout    30s;
      proxy_redirect off;
      proxy_http_version 1.1;
    }
  }
}
