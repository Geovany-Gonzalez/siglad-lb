# =========================
# NGINX para balancear 50/50 a dos frontends en Render
# - Failover rápido: si uno cae, reintenta en el otro en la misma request
# - Cuando ambos están arriba, reparte 50/50
# =========================

# (logs “normales” + info de upstream)
# En Render los ves en la pestaña Logs
log_format main '$remote_addr - $request '
                'status=$status rt=$request_time '
                'upstream=$upstream_addr ust=$upstream_status '
                'u_rt=$upstream_response_time ua="$http_user_agent"';

events { worker_connections 1024; }

http {
    # Resolver público para que NGINX vuelva a resolver los .onrender.com
    resolver 1.1.1.1 8.8.8.8 ipv6=off;
    resolver_timeout 5s;

    # TLS hacia los origins https:// (SNI correcto)
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;

    # Mantener conexiones keep-alive con los origins (mejora latencia)
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Cabeceras típicas hacia el origin
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;

    # ---- Upstreams (50/50) ----
    upstream siglad_fronts {
        # Si falla 1 vez en 5s, lo marcamos “malo” y no lo elegimos
        server siglad-proyecto.onrender.com    max_fails=1 fail_timeout=5s;
        server siglad-proyectoii.onrender.com  max_fails=1 fail_timeout=5s;

        # Conexiones persistentes a los origins
        keepalive 16;
    }

    server {
        listen 8080;
        server_name _;

        access_log /var/log/nginx/access.log main;

        # Comprobación simple: muestra a qué host se eligió esta vez
        location = /_lb/which {
            default_type text/plain;
            return 200 $upstream_peer_name;
        }

        # (opcional) health del balanceador
        location = /_lb/health {
            default_type application/json;
            return 200 '{"ok":true}';
        }

        # Todo lo demás se va a los frontends
        location / {
            proxy_pass https://siglad_fronts;

            # Timeouts cortos para cortar rápido si un origin está caído o despierto
            proxy_connect_timeout 1s;
            proxy_read_timeout    5s;
            proxy_send_timeout    5s;

            # Si hay error/timeout/5xx, reintenta en el otro peer (hasta 2 intentos total)
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;

            # No cachear errores
            proxy_no_cache     1;
            proxy_cache_bypass 1;
        }
    }
}
